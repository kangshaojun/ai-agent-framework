## æ¦‚è¿°
1.æ— æ³•äºŒæ¬¡ä¿®æ”¹
2.é…ç½®å¤æ‚

ä¼ä¸šç§æœ‰æ•°æ®
RGAæ£€ç´¢å¢å¼ºç”Ÿæˆ


## æŠ€æœ¯æ¶æ„:
reactnative + next.js + fastapi + langchian pandas weaviate ollama model docker


### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚  Next.js / React / ReactNative + TailwindCSS
â”‚   (Port: 3000)  â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP/HTTPS
         â”‚ SSE (Server-Sent Events)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Server        â”‚  FastAPI + SQLAlchemy + Redis + PGSQL
â”‚   (Port: 8000)  â”‚  JWT è®¤è¯ + CORS
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP
         â”‚ SSE
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent         â”‚  LangChain + Ollama + Weaviate + Pandas
â”‚   (Port: 8001)  â”‚  RAG æ£€ç´¢ + æµå¼ç”Ÿæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼         â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Weaviateâ”‚ â”‚ Ollama â”‚ â”‚  model   â”‚
â”‚ :8080  â”‚ â”‚:11434  â”‚ â”‚ deepseek â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Pandas æ•°æ®åŠ è½½ æ¸…æ´— ç‰¹å¾å¤„ç† æ•´ç†
Weaviateå‘é‡åŒ–æ•°æ®å¹¶å­˜å‚¨æ•°æ®
Ollama deepseek nomic-embed-text
LangChain prompt stdout


### ä¸‰å±‚æ¶æ„

1. **å‰ç«¯å±‚ (Frontend)** - ç”¨æˆ·äº¤äº’ç•Œé¢
2. **ä¸šåŠ¡å±‚ (Server)** - ä¸šåŠ¡é€»è¾‘ã€è®¤è¯ã€æ•°æ®ç®¡ç†
3. **AI å±‚ (Agent)** - AI æ¨ç†ã€å‘é‡æ£€ç´¢ã€çŸ¥è¯†åº“



## ğŸ¯ æŠ€æœ¯é€‰å‹

### å‰ç«¯ (Frontend)

| æŠ€æœ¯æ ˆ | ç‰ˆæœ¬ | ç”¨é€” |
|--------|------|------|
| **Next.js** | 13.5.6 | React æ¡†æ¶ï¼Œæ”¯æŒ SSR/SSG |
| **React** | 18.2.0 | UI ç»„ä»¶åº“ |
| **TypeScript** | 5.2.2 | ç±»å‹å®‰å…¨ |
| **TailwindCSS** | 3.3.5 | åŸå­åŒ– CSS æ¡†æ¶ |
| **Axios** | 1.6.0 | HTTP å®¢æˆ·ç«¯ |
| **@microsoft/fetch-event-source** | 2.0.1 | SSE æµå¼é€šä¿¡ |

**é€‰å‹ç†ç”±ï¼š**
- Next.js æä¾›ä¼˜ç§€çš„å¼€å‘ä½“éªŒå’Œæ€§èƒ½ä¼˜åŒ–
- TailwindCSS å¿«é€Ÿæ„å»ºç°ä»£åŒ– UI
- TypeScript æä¾›ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- SSE æ”¯æŒå®æ—¶æµå¼å¯¹è¯

---

### åç«¯ (Server)

| æŠ€æœ¯æ ˆ | ç‰ˆæœ¬ | ç”¨é€” |
|--------|------|------|
| **FastAPI** | 0.100.0 | ç°ä»£åŒ–å¼‚æ­¥ Web æ¡†æ¶ |
| **Uvicorn** | 0.31.1 | ASGI æœåŠ¡å™¨ |
| **SQLAlchemy** | 2.0.18+ | å¼‚æ­¥ ORM |
| **PostgreSQL** | - | å…³ç³»å‹æ•°æ®åº“ |
| **Redis** | 4.6.0+ | ç¼“å­˜å’Œä¼šè¯å­˜å‚¨ |
| **Alembic** | 1.11.1+ | æ•°æ®åº“è¿ç§»å·¥å…· |
| **Pydantic** | 2.0.0+ | æ•°æ®éªŒè¯ |
| **Python-Jose** | 3.3.0+ | JWT è®¤è¯ |
| **Passlib[bcrypt]** | 1.7.4+ | å¯†ç åŠ å¯† |
| **Loguru** | 0.7.0+ | ç»“æ„åŒ–æ—¥å¿— |

**é€‰å‹ç†ç”±ï¼š**
- FastAPI æä¾›é«˜æ€§èƒ½å¼‚æ­¥å¤„ç†å’Œè‡ªåŠ¨ API æ–‡æ¡£
- SQLAlchemy 2.0 åŸç”Ÿæ”¯æŒå¼‚æ­¥æ“ä½œ
- Redis æä¾›é«˜æ€§èƒ½ç¼“å­˜å’Œä¼šè¯ç®¡ç†
- JWT å®ç°æ— çŠ¶æ€è®¤è¯

---

### AI Agent

| æŠ€æœ¯æ ˆ | ç‰ˆæœ¬ | ç”¨é€” |
|--------|------|------|
| **LangChain** | 0.1.0+ | AI åº”ç”¨å¼€å‘æ¡†æ¶ |
| **LangChain-Community** | 0.0.10+ | ç¤¾åŒºé›†æˆ |
| **Ollama** | 0.1.0+ | æœ¬åœ° LLM æœåŠ¡ |
| **Weaviate** | 1.27.1 | å‘é‡æ•°æ®åº“ |
| **FastAPI** | 0.104.0+ | HTTP æœåŠ¡æ¡†æ¶ |
| **Pandas** | 2.0.0+ | æ•°æ®å¤„ç† |

**AI æ¨¡å‹ï¼š**
- **Chat Model**: `qwen2.5:7b` - å¯¹è¯ç”Ÿæˆ
- **Embedding Model**: `nomic-embed-text` - æ–‡æœ¬å‘é‡åŒ–

**é€‰å‹ç†ç”±ï¼š**
- LangChain æä¾›å®Œæ•´çš„ RAG å·¥å…·é“¾
- Ollama æ”¯æŒæœ¬åœ°éƒ¨ç½²ï¼Œä¿æŠ¤æ•°æ®éšç§
- Weaviate æä¾›é«˜æ€§èƒ½å‘é‡æ£€ç´¢
- æœ¬åœ°æ¨¡å‹é¿å… API è°ƒç”¨æˆæœ¬å’Œæ•°æ®æ³„éœ²é£é™©

---


## ä¼ è¾“åè®®
HTTP
WebSocket
SSE ä½  å¥½ ä»Šå¤© å¤©æ°”ä¸é”™
MCP AIæ ‡å‡†åè®® call list fun

FastMCP MCP åè®®æ”¯æŒSteamæµè¿™ä¸€å—ä¸å¤ªå®Œå–„ æ ‡å‡†å·²å®š


### SSE (Server-Sent Events)

**ç”¨é€”ï¼š** å®æ—¶æµå¼æ•°æ®ä¼ è¾“ï¼ˆAI å¯¹è¯æµå¼è¾“å‡ºï¼‰

**æµç¨‹ï¼š**
```
Frontend â†’ Server â†’ Agent
   SSE       SSE      SSE

Server â†’â†’â†’â†’â†’â†’ MCP/HTTP/SSE/GRPC/WebSocket â†’â†’â†’â†’â†’ ç¬¬ä¸‰æ–¹Agent(Wiki)/ç¬¬ä¸‰æ–¹æ¥å£
```

**SSE äº‹ä»¶ç±»å‹ï¼š**
```typescript
event: thinking   // æ€è€ƒçŠ¶æ€
data: {"status": "retrieving", "message": "æ­£åœ¨æ£€ç´¢..."}

event: sources    // æ£€ç´¢æ¥æº
data: {"sources": [...], "count": 5}

event: token      // é€ä¸ª token
data: {"token": "æ ¹æ®"}

event: done       // å®Œæˆ
data: {"answer": "...", "metadata": {...}}

event: error      // é”™è¯¯
data: {"code": 500, "msg": "é”™è¯¯ä¿¡æ¯"}
```

**ç‰¹ç‚¹ï¼š**
- å•å‘æ¨é€ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰
- è‡ªåŠ¨é‡è¿
- ä½å»¶è¿Ÿï¼Œå®æ—¶æ€§å¥½
- æ¯” WebSocket æ›´è½»é‡
---


## Model

å‰ç«¯--->æœç´¢--->å‘é‡æ•°æ®åº“--->æ‰¾åˆ°ç›¸ä¼¼çš„äº§å“--->ç»„ç»‡Prompt--->
äº¤ç»™LLM-->ç”Ÿæˆæƒ³è¦çš„ç­”æ¡ˆæˆ–æ€»ç»“--->è¿”å›ç»™å‰ç«¯


å‰ç«¯--->ç»„ç»‡Prompt--->äº¤ç»™è®­ç»ƒå¥½çš„Model-->ç”Ÿæˆæƒ³è¦çš„ç­”æ¡ˆæˆ–æ€»ç»“--->è¿”å›ç»™å‰ç«¯

## å‘é‡æ•°æ®åº“
Vector
WeaviateDB

æ¯”å¦‚ç°å®ä¸­ï¼š
è‹¹æœçš„æŒ‡çº¹ï¼š[çº¢è‰²ã€åœ†å½¢ã€ç”œã€å¯ç”Ÿåƒã€æ°´æœ]
æ©™å­çš„æŒ‡çº¹ï¼š[æ©™è‰²ã€åœ†å½¢ã€ç”œé…¸ã€å¯ç”Ÿåƒã€æ°´æœ]
é”¤å­çš„æŒ‡çº¹ï¼š[é‡‘å±ã€æ–¹å½¢ã€ç¡¬ã€å·¥å…·ã€ä¸å¯åƒ]


AI ä¸­ï¼š
æ¨¡å‹ä¼šæŠŠè¿™äº› â€œæ–‡å­—ç‰¹å¾â€ è½¬åŒ–ä¸ºã€Œæ•°å­—æ•°ç»„ã€ï¼ˆå‘é‡ï¼‰ï¼Œæ¯”å¦‚ï¼š
è‹¹æœï¼š[0.89, 0.72, 0.91, 0.85, 0.95]
æ©™å­ï¼š[0.71, 0.73, 0.82, 0.83, 0.94]
é”¤å­ï¼š[0.12, 0.25, 0.93, 0.88, 0.01]

ç›¸ä¼¼åº¦åˆ¤æ–­ï¼š
è‹¹æœå’Œæ©™å­çš„å‘é‡ â€œé•¿å¾—åƒâ€ï¼ˆæ•°å­—å·®å¼‚å°ï¼‰â†’ ä½™å¼¦ç›¸ä¼¼åº¦â‰ˆ0.92ï¼ˆè¯­ä¹‰è¿‘ï¼‰
è‹¹æœå’Œé”¤å­çš„å‘é‡ â€œé•¿å¾—ä¸åƒâ€ï¼ˆæ•°å­—å·®å¼‚å¤§ï¼‰â†’ ä½™å¼¦ç›¸ä¼¼åº¦â‰ˆ0.35ï¼ˆè¯­ä¹‰è¿œï¼‰

å‘é‡åŒ– embedding

RAGæ£€ç´¢å¢å¼ºç”Ÿæˆ

Likeæœç´¢
è¯­ä¹‰æœç´¢


## Token

"I love AI development"	
["I", " ", "love", " ", "AI", " ", "de", "vel", "op", "ment"]	
["æˆ‘", ""," å–œ "," æ¬¢ "," "," äºº "," å·¥ "," æ™º "," èƒ½ "," "," å¼€ "," å‘ "]

Splitæ‹†åˆ†

åŸå§‹æ–‡æœ¬--->Tokenæ‹†åˆ†--->Tokenç¼–ç --->Embedding--->å‘é‡æ•°æ®åº“

```
chunks = text_splitter.split_text(long_text)
```
æ¶ˆè€—Tokenâ€â‰ â€œå­—ç¬¦æ•° / å•è¯æ•°


## Promptæç¤ºè¯

JSP PHP Template
```
print("Hello World ${language}");
```

PromptTemplate
```
è¯·æä¾›ä»¥ä¸‹å•†å“ä¿¡æ¯ ${product} å•†å“ç¼–ç æ˜¯${product_id} è¯·åˆ—å‡ºå®ƒç›¸å…³çš„äº§å“ä»¥åŠä»·æ ¼
æˆ‘ä»¬éœ€è¦äº§å“çš„åç§° ä»·æ ¼ æè¿° å›¾ç‰‡èƒ½åŠå…¶ä»–ä¿¡æ¯


# System Promptï¼ˆå®šä¹‰è§’è‰²å’Œé€šç”¨è§„åˆ™ï¼‰
ä½ æ˜¯ä¸€åç”µå•†æ–‡æ¡ˆç­–åˆ’ï¼Œæ“…é•¿æ’°å†™çŸ­è§†é¢‘å¸¦è´§è„šæœ¬ã€‚è§„åˆ™ï¼š1. è„šæœ¬æ—¶é•¿æ§åˆ¶åœ¨ 30 ç§’å†…ï¼ˆçº¦ 80-100 å­—ï¼‰ï¼›2. å¼€å¤´ 3 ç§’å¸å¼•æ³¨æ„åŠ›ï¼›3. åŒ…å«äº§å“æ ¸å¿ƒå–ç‚¹ã€ä¼˜æƒ ä¿¡æ¯ã€è¡ŒåŠ¨æŒ‡ä»¤ï¼›4. è¯­è¨€å£è¯­åŒ–ï¼Œç¬¦åˆæŠ–éŸ³/å¿«æ‰‹ç”¨æˆ·é£æ ¼ï¼Œé¿å…ç”Ÿç¡¬å¹¿å‘Šã€‚

# User Promptï¼ˆæä¾›å…·ä½“ä»»åŠ¡å’Œä¸Šä¸‹æ–‡ï¼‰
äº§å“ï¼šæ— çº¿è“ç‰™è€³æœºï¼ˆæ ¸å¿ƒå–ç‚¹ï¼šç»­èˆª 30 å°æ—¶ã€é™å™ªåŠŸèƒ½ã€ä»·æ ¼ 99 å…ƒï¼›ä¼˜æƒ ä¿¡æ¯ï¼šå‰ 100 åä¸‹å•é€å……ç”µä»“ï¼‰ã€‚è¯·æ’°å†™ 1 æ¡å¸¦è´§è„šæœ¬ï¼Œå¼€å¤´ç”¨ç–‘é—®å¥å¸å¼•æ³¨æ„åŠ›ã€‚
```


å‰ç«¯--->æœç´¢--->å‘é‡æ•°æ®åº“--->æ‰¾åˆ°ç›¸ä¼¼çš„äº§å“--->ä½¿ç”¨PromptTemplate--->
æ·»åŠ è¾“å…¥å˜é‡ç»„è£…Prompt--->äº¤ç»™LLM-->ç”Ÿæˆæƒ³è¦çš„ç­”æ¡ˆæˆ–æ€»ç»“--->è¿”å›ç»™å‰ç«¯

## Agent

å¯¼å…¥æ•°æ®CSVæ•°æ®--->Pandasæ•°æ®æ•´ç†æ¸…æ´—ç‰¹æ€§--->å‘é‡åµŒå…¥--->Weaviateå‘é‡æ•°æ®åº“
ä½¿ç”¨WeaviateSDKç›¸å…³æ–¹æ³•--->æŸ¥è¯¢æ•°æ®--->æä¾›æŸ¥è¯¢æ¥å£
æä¾›æŸ¥è¯¢æ¥å£--->ä½¿ç”¨PromptTemplate--->ç»„è£…æŸ¥è¯¢æ•°æ®--->äº¤ç»™LLM(LangChian)-->ç”Ÿæˆæƒ³è¦çš„ç­”æ¡ˆæˆ–æ€»ç»“--->è¿”å›ç»™Serverç«¯


### æœç´¢
é—®äº†ä¸€ä¸ªé—®é¢˜--->å‘é‡åŒ–--->ç”ŸæˆæŸ¥è¯¢å‘é‡--->åœ¨Weaviateä¸­æœç´¢--->è½¬æˆDocumentè¿”å›

### LCELé—®ç­”é“¾
è¾“å…¥å¤„ç†--->æç¤ºè¯æ¨¡æ¿--->LLMè°ƒç”¨--->è¾“å‡ºè§£æ (é€šè¿‡ç®¡é“æ“ä½œç¬¦ | ä¸²èµ·æ•´ä¸ªæµç¨‹)
å…¸å‹çš„RAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)æ¨¡å¼ç”Ÿæˆ

### ç»Ÿä¸€è¿”å›æ ¼å¼
- code: ä¸šåŠ¡çŠ¶æ€ç  (0=æˆåŠŸ, 2000-2999=Agenté”™è¯¯)
- msg: æç¤ºä¿¡æ¯
- data: ä¸šåŠ¡æ•°æ®


### Streamç”Ÿæˆç­”æ¡ˆ
```
"""
æµå¼é—®ç­”ï¼Œé€ token è¿”å›ç­”æ¡ˆã€‚

Args:
   question: å®¢æœé—®é¢˜
   
Yields:
   dict: æµå¼äº‹ä»¶ï¼Œæ ¼å¼:
   {
         "type": "thinking" | "sources" | "token" | "done" | "error",
         "data": {...}
   }
"""
LangChain astream chunk å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å…¶ä»–ç±»å‹
```

### HTTP SSEæœåŠ¡ç›¸å…³
```
media_type="text/event-stream"
headers={
   "Cache-Control": "no-cache",
   "Connection": "keep-alive",
   "X-Accel-Buffering": "no",
}

è¿”å› SSE æ ¼å¼çš„æµå¼æ•°æ®ï¼š
- event: thinking (æ€è€ƒçŠ¶æ€)
- event: sources (æ£€ç´¢æ¥æº)
- event: token (é€ä¸ª token)
- event: done (å®Œæˆ)
- event: error (é”™è¯¯)
```

## Serverç«¯
## ç‰¹æ€§

- âœ… **FastAPI** - ç°ä»£åŒ–çš„å¼‚æ­¥ Web æ¡†æ¶ï¼Œæ”¯æŒ SSE æµå¼ä¼ è¾“
- âœ… **SQLAlchemy 2.0** - å¼‚æ­¥ ORMï¼Œæ”¯æŒ PostgreSQL
- âœ… **Redis** - ç¼“å­˜æ”¯æŒï¼Œæå‡å“åº”é€Ÿåº¦
- âœ… **JWT** - è®¤è¯ç³»ç»Ÿï¼Œä¿éšœæ¥å£å®‰å…¨
- âœ… **Loguru** - ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜è¿½è¸ª
- âœ… **Docker** - æ•°æ®åº“å®¹å™¨åŒ–ï¼Œç®€åŒ–éƒ¨ç½²
- âœ… **Alembic** - æ•°æ®åº“è¿ç§»

## Loguru æ—¥å¿—ç³»ç»Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ‡å‡† logging    â”‚ â”€â”€â–¶ â”‚ InterceptHandler â”‚ â”€â”€â–¶ â”‚ Loguru  â”‚ â”€â”€â–¶ stdout
â”‚ (uvicorn ç­‰)    â”‚     â”‚   (æ‹¦æˆªè½¬å‘)      â”‚     â”‚ (æ ¼å¼åŒ–) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## Alembic
alembic revision --autogenerate -m "delete nickname to user"
alembic upgrade head

## JWT Token


ç”¨æˆ·ç™»å½• â”€â”€â–º è·å– access_token + refresh_token
              â”‚
              â–¼
         è®¿é—®å—ä¿æŠ¤ APIï¼ˆæºå¸¦ access_tokenï¼‰
              â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚
  æˆåŠŸè¿”å›          401 è¿‡æœŸ
                       â”‚
                       â–¼
              è‡ªåŠ¨ç”¨ refresh_token åˆ·æ–°
                       â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                       â”‚
       åˆ·æ–°æˆåŠŸ                 åˆ·æ–°å¤±è´¥
           â”‚                       â”‚
           â–¼                       â–¼
    ä¿å­˜æ–° tokens              æ¸…é™¤ tokens
    é‡è¯•åŸå§‹è¯·æ±‚               è·³è½¬ç™»å½•é¡µ

JWT JSON Web Token
Header HS256
Payload user_id username exp type
Signature ç”¨å¯†é’¥ç­¾å


## äº¤äº’è§„èŒƒ
å‚è€ƒé”™è¯¯ç è§„èŒƒ:
- 0: æˆåŠŸ
- 1000: å‚æ•°é”™è¯¯
- 1001: ä¸šåŠ¡é€»è¾‘é”™è¯¯
- 1002: æ•°æ®å¤„ç†é”™è¯¯
- å…¶ä»–: è‡ªå®šä¹‰ä¸šåŠ¡é”™è¯¯

è¿”å›æ ¼å¼:
code msg data
{
   "code": 0,
   "msg": "success",
   "data": {...}
}