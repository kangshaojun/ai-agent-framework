# ä¸‰å±‚æ¶æ„è®¾è®¡ï¼šå‰ç«¯+ä¸šåŠ¡+AIå±‚çš„èŒè´£åˆ’åˆ†

## å‰è¨€

åœ¨æ„å»ºä¼ä¸šçº§AI Agentç³»ç»Ÿæ—¶ï¼Œæ¸…æ™°çš„æ¶æ„åˆ†å±‚è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»æœ¬é¡¹ç›®é‡‡ç”¨çš„ä¸‰å±‚æ¶æ„è®¾è®¡ï¼Œä»¥åŠå„å±‚çš„èŒè´£åˆ’åˆ†å’Œé€šä¿¡æœºåˆ¶ã€‚

**é€‚åˆè¯»è€…ï¼š** æ¶æ„å¸ˆã€å…¨æ ˆå·¥ç¨‹å¸ˆã€æŠ€æœ¯Leader

---

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚æ¶æ„

### 1.1 å•ä½“æ¶æ„çš„é—®é¢˜

```
ä¼ ç»Ÿå•ä½“æ¶æ„ï¼š
Frontend + Backend + AI æ··åœ¨ä¸€èµ·
â”œâ”€â”€ ä»£ç è€¦åˆä¸¥é‡
â”œâ”€â”€ éš¾ä»¥ç‹¬ç«‹æ‰©å±•
â”œâ”€â”€ æŠ€æœ¯æ ˆå—é™
â””â”€â”€ å›¢é˜Ÿåä½œå›°éš¾
```

### 1.2 ä¸‰å±‚æ¶æ„çš„ä¼˜åŠ¿

```
ä¸‰å±‚æ¶æ„ï¼š
Frontend â† â†’ Server â† â†’ Agent
â”œâ”€â”€ èŒè´£æ¸…æ™°
â”œâ”€â”€ ç‹¬ç«‹éƒ¨ç½²
â”œâ”€â”€ æŠ€æœ¯æ ˆè‡ªç”±
â”œâ”€â”€ æ˜“äºæ‰©å±•
â””â”€â”€ å›¢é˜Ÿå¹¶è¡Œå¼€å‘
```

---

## äºŒã€æ¶æ„å…¨æ™¯å›¾

### 2.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·å±‚                              â”‚
â”‚                   (æµè§ˆå™¨/ç§»åŠ¨ç«¯)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Frontend Layer                         â”‚
â”‚              Next.js + React + TailwindCSS               â”‚
â”‚                   (Port: 3000)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ èŠå¤©ç•Œé¢ â”‚  â”‚ ç”¨æˆ·è®¤è¯ â”‚  â”‚ å¯¹è¯ç®¡ç† â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/SSE
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Server Layer                           â”‚
â”‚          FastAPI + PostgreSQL + Redis                    â”‚
â”‚                   (Port: 8000)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ ä¸šåŠ¡é€»è¾‘ â”‚  â”‚ ç”¨æˆ·ç®¡ç† â”‚  â”‚ æ•°æ®å­˜å‚¨ â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ JWTè®¤è¯  â”‚  â”‚ ç¼“å­˜ç®¡ç† â”‚  â”‚ æ—¥å¿—è®°å½• â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/SSE
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Layer                           â”‚
â”‚         LangChain + Ollama + Weaviate                    â”‚
â”‚                   (Port: 8001)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ RAGæ£€ç´¢  â”‚  â”‚ Promptç»„è£…â”‚  â”‚ æµå¼ç”Ÿæˆ â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼            â–¼            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Weaviateâ”‚  â”‚ Ollama â”‚  â”‚PostgreSQLâ”‚
   â”‚ :8080  â”‚  â”‚:11434  â”‚  â”‚  :5432   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€Frontend Layerï¼ˆå‰ç«¯å±‚ï¼‰

### 3.1 æ ¸å¿ƒèŒè´£

**ä¸»è¦èŒè´£ï¼š**
- ğŸ¨ **ç”¨æˆ·ç•Œé¢** - æä¾›å‹å¥½çš„äº¤äº’ä½“éªŒ
- ğŸ” **èº«ä»½è®¤è¯** - Tokenç®¡ç†å’Œè‡ªåŠ¨åˆ·æ–°
- ğŸ“¡ **å®æ—¶é€šä¿¡** - SSEæµå¼æ¥æ”¶AIå›å¤
- ğŸ’¾ **çŠ¶æ€ç®¡ç†** - å¯¹è¯å†å²å’Œç”¨æˆ·çŠ¶æ€
- ğŸ¯ **è·¯ç”±ç®¡ç†** - é¡µé¢å¯¼èˆªå’Œæƒé™æ§åˆ¶

### 3.2 æŠ€æœ¯æ ˆ

```typescript
// æŠ€æœ¯é€‰å‹
Frontend Stack:
â”œâ”€â”€ Next.js 13.5.6      // Reactæ¡†æ¶ï¼Œæ”¯æŒSSR
â”œâ”€â”€ React 18.2.0        // UIç»„ä»¶åº“
â”œâ”€â”€ TypeScript 5.2.2    // ç±»å‹å®‰å…¨
â”œâ”€â”€ TailwindCSS 3.3.5   // åŸå­åŒ–CSS
â”œâ”€â”€ Axios 1.6.0         // HTTPå®¢æˆ·ç«¯
â””â”€â”€ @microsoft/fetch-event-source 2.0.1  // SSEæ”¯æŒ
```

### 3.3 æ ¸å¿ƒä»£ç ç¤ºä¾‹

```typescript
// frontend/app/chat/page.tsx
'use client'

import { useState } from 'react'
import { streamChat } from '@/lib/api-client'

export default function ChatPage() {
  const [messages, setMessages] = useState<Message[]>([])
  const [inputValue, setInputValue] = useState('')
  const [isStreaming, setIsStreaming] = useState(false)
  const [currentAnswer, setCurrentAnswer] = useState('')

  const handleSend = async () => {
    if (!inputValue.trim() || isStreaming) return

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage = {
      id: Date.now().toString(),
      role: 'user',
      content: inputValue
    }
    setMessages(prev => [...prev, userMessage])
    setInputValue('')
    setIsStreaming(true)
    setCurrentAnswer('')

    try {
      // è°ƒç”¨Server APIï¼Œæ¥æ”¶æµå¼å“åº”
      await streamChat(userMessage.content, {
        onToken: (token) => {
          setCurrentAnswer(prev => prev + token)
        },
        onDone: (data) => {
          const aiMessage = {
            id: Date.now().toString(),
            role: 'assistant',
            content: data.answer
          }
          setMessages(prev => [...prev, aiMessage])
          setCurrentAnswer('')
          setIsStreaming(false)
        },
        onError: (error) => {
          console.error('é”™è¯¯:', error)
          setIsStreaming(false)
        }
      })
    } catch (error) {
      console.error('å‘é€å¤±è´¥:', error)
      setIsStreaming(false)
    }
  }

  return (
    <div className="flex flex-col h-screen">
      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto p-4">
        {messages.map((msg) => (
          <MessageBubble key={msg.id} message={msg} />
        ))}
        
        {/* å®æ—¶æµå¼æ¶ˆæ¯ */}
        {currentAnswer && (
          <div className="bg-gray-100 rounded-lg p-4">
            {currentAnswer}
            <span className="animate-pulse">â–Š</span>
          </div>
        )}
      </div>

      {/* è¾“å…¥æ¡† */}
      <div className="p-4 border-t">
        <input
          value={inputValue}
          onChange={(e) => setInputValue(e.target.value)}
          onKeyPress={(e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault()
              handleSend()
            }
          }}
          placeholder="è¾“å…¥é—®é¢˜..."
          disabled={isStreaming}
        />
        <button onClick={handleSend} disabled={!inputValue.trim() || isStreaming}>
          {isStreaming ? 'ç”Ÿæˆä¸­...' : 'å‘é€'}
        </button>
      </div>
    </div>
  )
}
```

---

## å››ã€Server Layerï¼ˆä¸šåŠ¡å±‚ï¼‰

### 4.1 æ ¸å¿ƒèŒè´£

**ä¸»è¦èŒè´£ï¼š**
- ğŸ”’ **è®¤è¯æˆæƒ** - JWTåŒTokenæœºåˆ¶
- ğŸ’¼ **ä¸šåŠ¡é€»è¾‘** - ç”¨æˆ·ç®¡ç†ã€å¯¹è¯ç®¡ç†
- ğŸ—„ï¸ **æ•°æ®æŒä¹…åŒ–** - PostgreSQLå­˜å‚¨
- âš¡ **ç¼“å­˜ç®¡ç†** - RedisåŠ é€Ÿ
- ğŸ”— **æœåŠ¡ç¼–æ’** - åè°ƒFrontendå’ŒAgent
- ğŸ“Š **æ—¥å¿—ç›‘æ§** - Loguruç»“æ„åŒ–æ—¥å¿—

### 4.2 æŠ€æœ¯æ ˆ

```python
# æŠ€æœ¯é€‰å‹
Server Stack:
â”œâ”€â”€ FastAPI 0.100.0         # ç°ä»£åŒ–å¼‚æ­¥Webæ¡†æ¶
â”œâ”€â”€ Uvicorn 0.31.1          # ASGIæœåŠ¡å™¨
â”œâ”€â”€ SQLAlchemy 2.0.18+      # å¼‚æ­¥ORM
â”œâ”€â”€ PostgreSQL              # å…³ç³»å‹æ•°æ®åº“
â”œâ”€â”€ Redis 4.6.0+            # ç¼“å­˜å’Œä¼šè¯
â”œâ”€â”€ Alembic 1.11.1+         # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ Pydantic 2.0.0+         # æ•°æ®éªŒè¯
â”œâ”€â”€ Python-Jose 3.3.0+      # JWTè®¤è¯
â”œâ”€â”€ Passlib[bcrypt] 1.7.4+  # å¯†ç åŠ å¯†
â””â”€â”€ Loguru 0.7.0+           # ç»“æ„åŒ–æ—¥å¿—
```

### 4.3 æ ¸å¿ƒä»£ç ç¤ºä¾‹

```python
# server/api/agent.py
from fastapi import APIRouter, Depends, HTTPException
from fastapi.responses import StreamingResponse
import httpx
import json

router = APIRouter(prefix="/api/agent", tags=["agent"])

AGENT_URL = "http://localhost:8001"

@router.post("/chat/stream")
async def agent_stream(
    question: str,
    current_user = Depends(get_current_user)
):
    """
    ä»£ç†Agentæµå¼æ¥å£
    
    Serverä½œä¸ºä¸­é—´å±‚ï¼š
    1. éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆJWTï¼‰
    2. è®°å½•è¯·æ±‚æ—¥å¿—
    3. è½¬å‘åˆ°AgentæœåŠ¡
    4. ä¿å­˜å¯¹è¯å†å²
    """
    
    # è®°å½•è¯·æ±‚
    logger.info(f"ç”¨æˆ· {current_user.username} å‘èµ·é—®ç­”: {question}")
    
    async def event_generator():
        async with httpx.AsyncClient() as client:
            async with client.stream(
                "POST",
                f"{AGENT_URL}/stream",
                json={"question": question},
                timeout=60.0
            ) as response:
                async for line in response.aiter_lines():
                    if line:
                        yield f"{line}\n"
    
    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream"
    )


# server/api/auth.py
from datetime import timedelta
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession

router = APIRouter(prefix="/api/auth", tags=["auth"])

@router.post("/login")
async def login(
    username: str,
    password: str,
    db: AsyncSession = Depends(get_db)
):
    """ç”¨æˆ·ç™»å½•"""
    # éªŒè¯ç”¨æˆ·
    user = await authenticate_user(db, username, password)
    if not user:
        raise HTTPException(status_code=401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    
    # ç”ŸæˆToken
    access_token = create_access_token(
        data={"sub": user.username},
        expires_delta=timedelta(minutes=30)
    )
    refresh_token = create_refresh_token(
        data={"sub": user.username},
        expires_delta=timedelta(days=7)
    )
    
    return {
        "code": 0,
        "msg": "ç™»å½•æˆåŠŸ",
        "data": {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer"
        }
    }


# server/api/conversations.py
@router.post("")
async def create_conversation(
    title: str,
    current_user = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """åˆ›å»ºæ–°å¯¹è¯"""
    conversation = Conversation(
        user_id=current_user.id,
        title=title
    )
    db.add(conversation)
    await db.commit()
    await db.refresh(conversation)
    
    return {
        "code": 0,
        "msg": "åˆ›å»ºæˆåŠŸ",
        "data": conversation
    }
```

---

## äº”ã€Agent Layerï¼ˆAIå±‚ï¼‰

### 5.1 æ ¸å¿ƒèŒè´£

**ä¸»è¦èŒè´£ï¼š**
- ğŸ” **å‘é‡æ£€ç´¢** - Weaviateç›¸ä¼¼åº¦æœç´¢
- ğŸ§  **AIæ¨ç†** - Ollama LLMç”Ÿæˆ
- ğŸ“ **Promptå·¥ç¨‹** - åŠ¨æ€ç»„è£…ä¸Šä¸‹æ–‡
- ğŸŒŠ **æµå¼ç”Ÿæˆ** - å®æ—¶è¿”å›Token
- ğŸ“Š **ç»“æœæ ¼å¼åŒ–** - ç»Ÿä¸€å“åº”æ ¼å¼

### 5.2 æŠ€æœ¯æ ˆ

```python
# æŠ€æœ¯é€‰å‹
Agent Stack:
â”œâ”€â”€ LangChain 0.1.0+           # AIåº”ç”¨å¼€å‘æ¡†æ¶
â”œâ”€â”€ LangChain-Community 0.0.10+ # ç¤¾åŒºé›†æˆ
â”œâ”€â”€ Ollama 0.1.0+              # æœ¬åœ°LLMæœåŠ¡
â”œâ”€â”€ Weaviate 1.27.1            # å‘é‡æ•°æ®åº“
â”œâ”€â”€ FastAPI 0.104.0+           # HTTPæœåŠ¡æ¡†æ¶
â””â”€â”€ Pandas 2.0.0+              # æ•°æ®å¤„ç†

AIæ¨¡å‹:
â”œâ”€â”€ llama3.2:latest     # å¯¹è¯ç”Ÿæˆæ¨¡å‹
â””â”€â”€ nomic-embed-text    # æ–‡æœ¬å‘é‡åŒ–æ¨¡å‹
```

### 5.3 æ ¸å¿ƒä»£ç ç¤ºä¾‹

```python
# agent/http_service.py
from fastapi import FastAPI
from fastapi.responses import StreamingResponse
from pydantic import BaseModel
import json

from agent import ServiceTicketAgent

app = FastAPI(title="Service Ticket Agent")

class ChatRequest(BaseModel):
    question: str

agent_instance = None

def get_agent():
    global agent_instance
    if agent_instance is None:
        agent_instance = ServiceTicketAgent()
    return agent_instance


@app.post("/stream")
async def stream_chat(request: ChatRequest):
    """
    æµå¼å¯¹è¯æ¥å£ï¼ˆSSEï¼‰
    
    è¿”å›SSEæ ¼å¼çš„æµå¼æ•°æ®ï¼š
    - event: thinking (æ€è€ƒçŠ¶æ€)
    - event: sources (æ£€ç´¢æ¥æº)
    - event: token (é€ä¸ªtoken)
    - event: done (å®Œæˆ)
    - event: error (é”™è¯¯)
    """
    async def event_generator():
        agent = get_agent()
        
        try:
            async for event in agent.ask_stream(request.question):
                event_type = event.get("type")
                event_data = event.get("data", {})
                
                # æ ¼å¼åŒ–ä¸ºSSE
                yield f"event: {event_type}\n"
                yield f"data: {json.dumps(event_data, ensure_ascii=False)}\n\n"
                
                if event_type in ["done", "error"]:
                    break
                    
        except Exception as e:
            error_event = {"code": 500, "msg": f"Agenté”™è¯¯: {str(e)}"}
            yield f"event: error\n"
            yield f"data: {json.dumps(error_event, ensure_ascii=False)}\n\n"
    
    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no",
        }
    )


# agent/ticket_agent.py
from langchain_core.runnables import RunnablePassthrough
from langchain_core.output_parsers import StrOutputParser

class ServiceTicketAgent:
    def _setup_qa_chain(self):
        """è®¾ç½®é—®ç­”é“¾ï¼ˆLCELï¼‰"""
        
        def retrieve_and_format(question):
            docs = self._search_similar_documents(question)
            return "\n\n".join(doc.page_content for doc in docs)
        
        # LCELé“¾å¼è°ƒç”¨
        self.qa_chain = (
            {
                "context": retrieve_and_format,
                "question": RunnablePassthrough()
            }
            | self.prompt_template
            | self.llm
            | StrOutputParser()
        )
        
        return self.qa_chain
    
    async def ask_stream(self, question: str):
        """æµå¼é—®ç­”"""
        # 1. æ£€ç´¢ç›¸å…³å·¥å•
        yield {
            "type": "thinking",
            "data": {"status": "retrieving", "message": "æ­£åœ¨æ£€ç´¢ç›¸å…³å·¥å•..."}
        }
        
        source_docs = self._search_similar_documents(question)
        
        # 2. è¿”å›æ£€ç´¢ç»“æœ
        yield {
            "type": "sources",
            "data": {"sources": [...], "count": len(source_docs)}
        }
        
        # 3. æµå¼ç”Ÿæˆç­”æ¡ˆ
        qa_chain = self._setup_qa_chain()
        
        full_answer = ""
        async for chunk in qa_chain.astream(question):
            token = str(chunk)
            full_answer += token
            
            yield {
                "type": "token",
                "data": {"token": token}
            }
        
        # 4. å®Œæˆ
        yield {
            "type": "done",
            "data": {"answer": full_answer, "metadata": {...}}
        }
```

---

## å…­ã€å±‚é—´é€šä¿¡åè®®

### 6.1 Frontend â†” Server

```typescript
// HTTPè¯·æ±‚
POST /api/auth/login
Content-Type: application/json

{
  "username": "user",
  "password": "password"
}

// HTTPå“åº”
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJ...",
    "refresh_token": "eyJ..."
  }
}

// SSEæµå¼å“åº”
POST /api/agent/chat/stream
Authorization: Bearer eyJ...

event: token
data: {"token": "æ ¹æ®"}

event: token
data: {"token": "å†å²"}

event: done
data: {"answer": "...", "metadata": {...}}
```

### 6.2 Server â†” Agent

```python
# HTTPä»£ç†
POST http://localhost:8001/stream
Content-Type: application/json

{
  "question": "ç‰©æµä¿¡æ¯5å¤©æ²¡æ›´æ–°ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ"
}

# SSEå“åº”
event: thinking
data: {"status": "retrieving", "message": "æ­£åœ¨æ£€ç´¢ç›¸å…³å·¥å•..."}

event: sources
data: {"sources": [...], "count": 5}

event: token
data: {"token": "æ ¹æ®"}

event: done
data: {"answer": "...", "metadata": {...}}
```

---

## ä¸ƒã€ç‹¬ç«‹éƒ¨ç½²ä¸æ‰©å±•

### 7.1 ç‹¬ç«‹éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - server

  server:
    build: ./server
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis
      - agent

  agent:
    build: ./agent
    ports:
      - "8001:8001"
    depends_on:
      - ollama
      - weaviate

  postgres:
    image: postgres:15
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  weaviate:
    image: semitechnologies/weaviate:1.27.1
    ports:
      - "8080:8080"

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
```

### 7.2 æ°´å¹³æ‰©å±•

```yaml
# æ‰©å±•Agentå±‚
services:
  agent:
    build: ./agent
    deploy:
      replicas: 3  # 3ä¸ªAgentå®ä¾‹
    ports:
      - "8001-8003:8001"

  # è´Ÿè½½å‡è¡¡
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
```

---

## å…«ã€å›¢é˜Ÿåä½œ

### 8.1 èŒè´£åˆ†å·¥

```
Frontendå›¢é˜Ÿ:
â”œâ”€â”€ UI/UXè®¾è®¡
â”œâ”€â”€ Reactç»„ä»¶å¼€å‘
â”œâ”€â”€ çŠ¶æ€ç®¡ç†
â””â”€â”€ å‰ç«¯æ€§èƒ½ä¼˜åŒ–

Serverå›¢é˜Ÿ:
â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘å¼€å‘
â”œâ”€â”€ æ•°æ®åº“è®¾è®¡
â”œâ”€â”€ APIæ¥å£è®¾è®¡
â””â”€â”€ è®¤è¯æˆæƒ

Agentå›¢é˜Ÿ:
â”œâ”€â”€ AIæ¨¡å‹é€‰å‹
â”œâ”€â”€ Promptå·¥ç¨‹
â”œâ”€â”€ RAGä¼˜åŒ–
â””â”€â”€ å‘é‡æ•°æ®åº“ç®¡ç†
```

### 8.2 å¹¶è¡Œå¼€å‘

```
é˜¶æ®µ1: æ¥å£å®šä¹‰ï¼ˆ1å¤©ï¼‰
â”œâ”€â”€ Frontendå®šä¹‰éœ€è¦çš„API
â”œâ”€â”€ Serverå®šä¹‰Agentæ¥å£
â””â”€â”€ ä¸‰æ–¹è¾¾æˆä¸€è‡´

é˜¶æ®µ2: å¹¶è¡Œå¼€å‘ï¼ˆ2å‘¨ï¼‰
â”œâ”€â”€ Frontend: Mockæ•°æ®å¼€å‘UI
â”œâ”€â”€ Server: å®ç°ä¸šåŠ¡é€»è¾‘
â””â”€â”€ Agent: å®ç°AIåŠŸèƒ½

é˜¶æ®µ3: è”è°ƒæµ‹è¯•ï¼ˆ3å¤©ï¼‰
â”œâ”€â”€ Frontend + Serverè”è°ƒ
â”œâ”€â”€ Server + Agentè”è°ƒ
â””â”€â”€ ç«¯åˆ°ç«¯æµ‹è¯•
```

---

## ä¹ã€æ€»ç»“

ä¸‰å±‚æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

âœ… **èŒè´£æ¸…æ™°** - æ¯å±‚ä¸“æ³¨è‡ªå·±çš„é¢†åŸŸ  
âœ… **ç‹¬ç«‹éƒ¨ç½²** - å¯ä»¥å•ç‹¬æ‰©å±•å’Œå‡çº§  
âœ… **æŠ€æœ¯è‡ªç”±** - æ¯å±‚é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯æ ˆ  
âœ… **å›¢é˜Ÿåä½œ** - å¤šå›¢é˜Ÿå¹¶è¡Œå¼€å‘  
âœ… **æ˜“äºç»´æŠ¤** - é™ä½ç³»ç»Ÿå¤æ‚åº¦  

**ä¸‹ä¸€ç¯‡é¢„å‘Šï¼š** ã€ŠæŠ€æœ¯é€‰å‹èƒŒåçš„æ€è€ƒï¼šä¸ºä»€ä¹ˆé€‰æ‹©Next.js+FastAPI+LangChainã€‹

æˆ‘ä»¬å°†æ·±å…¥åˆ†ææ¯ä¸ªæŠ€æœ¯æ ˆçš„é€‰å‹ç†ç”±å’Œæ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”ã€‚

---

**ä½œè€…ç®€ä»‹ï¼š** èµ„æ·±å¼€å‘è€…ï¼Œåˆ›ä¸šè€…ã€‚ä¸“æ³¨äºè§†é¢‘é€šè®¯æŠ€æœ¯é¢†åŸŸã€‚å›½å†…é¦–æœ¬Flutterè‘—ä½œã€ŠFlutteræŠ€æœ¯å…¥é—¨ä¸å®æˆ˜ã€‹ä½œè€…,å¦è‘—æœ‰ã€ŠDartè¯­è¨€å®æˆ˜ã€‹åŠã€ŠWebRTCéŸ³è§†é¢‘å¼€å‘ã€‹ç­‰ä¹¦ç±ã€‚å¤šå¹´ä»äº‹è§†é¢‘ä¼šè®®ã€è¿œç¨‹æ•™è‚²ç­‰æŠ€æœ¯ç ”å‘ï¼Œå¯¹äºAndroidã€iOSä»¥åŠè·¨å¹³å°å¼€å‘æŠ€æœ¯æœ‰æ¯”è¾ƒæ·±å…¥çš„ç ”ç©¶å’Œåº”ç”¨ï¼Œä½œä¸ºä¸»è¦ç¨‹åºå‘˜å¼€å‘äº†å¤šä¸ªåº”ç”¨é¡¹ç›®ï¼Œæ¶‰åŠåŒ»ç–—ã€äº¤é€šã€é“¶è¡Œç­‰é¢†åŸŸã€‚

**å­¦ä¹ èµ„æ–™ï¼š**
- [ai-agent-framework](https://www.bilibili.com/cheese/play/ep2187729)
- [ä½œè€…GitHub](https://github.com/kangshaojun)

**æ¬¢è¿äº¤æµï¼š** å¦‚æœ‰é—®é¢˜æ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®º ğŸš€
